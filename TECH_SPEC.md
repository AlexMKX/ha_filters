# Техническое задание: Интеграция Home Assistant для автоматического назначения областей устройствам

## Цель
Разработать пользовательскую интеграцию Home Assistant, которая при запуске системы и по запросу пользователя автоматически назначает область (area) устройствам на основании совпадения их `object_id` с алиасами областей.

## Область применения
Интеграция предназначена для пользователей Home Assistant, использующих единообразное именование сущностей: `object_id` устройств начинается с алиаса соответствующей области. Решение должно работать в любой установке Home Assistant, поддерживающей пользовательские интеграции (custom components).

## Требования

### 1. Источники данных
- Реестр областей (`area_registry`): требуется получить список всех областей и их алиасов.
- Реестр сущностей (`entity_registry`): необходимо перебрать все сущности для поиска совпадений по `object_id`.
- Реестр устройств (`device_registry`): используется для проверки и назначения области устройству.

### 2. Алгоритм назначения областей
1. Получить все области и сформировать карту `slug(alias) -> area_id`. В карту также включить основное имя области, преобразованное к slug, чтобы поддержать совпадения с именами без явных алиасов.
2. Получить все сущности из реестра. Для каждой сущности:
   - Нормализовать `object_id` (использовать slug в исходном виде, так как Home Assistant уже формирует `object_id` в формате slug).
   - Найти соответствие между `object_id` и любым ключом из карты алиасов по условию «`object_id` начинается с alias».
   - Если соответствие найдено и у сущности есть `device_id`, проверить устройство в реестре устройств.
   - Если у устройства не назначена область (`area_id is None`), обновить устройство, установив `area_id` равным найденной области.
3. Вести логирование: количество найденных соответствий, количество назначенных областей, список пропусков (например, сущности без `device_id`).

### 3. Взаимодействие с Home Assistant
- Интеграция должна запускать алгоритм при старте Home Assistant (`async_setup` через задачу `hass.async_create_task`).
- Пользователь должен иметь возможность повторно вызвать процесс через зарегистрированный сервис `auto_area_assign.refresh`.
- Логирование должно выполняться через стандартный `logging.getLogger(__name__)` с уровнями `INFO` и `DEBUG`.

### 4. Структура проекта
```
custom_components/
  auto_area_assign/
    __init__.py        # точка входа интеграции, реализация алгоритма и регистрация сервиса
    manifest.json      # метаданные интеграции
```
- `manifest.json` должен описывать название, версию, зависимость от Home Assistant `core` >= 2023.5.0 (версия с поддержкой `area.aliases`).

### 5. Тестирование
- Юнит-тесты с использованием `pytest` и фикстур Home Assistant для эмуляции реестров.
- Тесты должны проверять:
  1. Назначение области устройству, если `object_id` начинается с алиаса.
  2. Отсутствие изменений, если область уже назначена.
  3. Игнорирование сущностей без `device_id`.

### 6. Документация
- Добавить `README.md` для описания назначения интеграции, схемы работы и инструкций по установке и вызову сервиса.
- В `README.md` привести пример настройки именования сущностей и ожидаемого поведения.

### 7. Нефункциональные требования
- Код должен соответствовать стандартам PEP 8 и стилю Home Assistant.
- Все асинхронные операции выполняются через доступные асинхронные API Home Assistant.
- Избегать блокирующих вызовов.

## Этапы реализации
1. Создание структуры интеграции (`custom_components/auto_area_assign`) и метаданных (`manifest.json`).
2. Реализация алгоритма в `__init__.py`.
3. Регистрация сервиса для повторного запуска алгоритма.
4. Разработка тестов и настройка `pytest`.
5. Написание документации в `README.md`.
6. Проверка линтеров/тестов, подготовка коммита и PR.

